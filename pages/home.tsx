import type { NextPage } from "next";
import { useSession } from "next-auth/react";
import Head from "next/head";
import { useRouter } from "next/router";
import { useState } from "react";
import api from "../services/api";

interface ILink {
    title: string;
    link: string;
}

interface HomeProps {
    data: {
        links: ILink[];
    };
}

const Home: NextPage<HomeProps> = ({ data }) => {
    const links = data.links;
    const router = useRouter();
    let hostname = "";

    if (typeof window !== "undefined") {
        hostname = window.location.origin;
    }

    const { status } = useSession();

    const [input, setInput] = useState("");
    const [shortUrl, setShortUrl] = useState<string | any>("...");
    console.log(input);

    console.log(links);
    return (
        <div className="flex justify-center items-center min-h-screen bg-sky-400">
            <Head>
                <title>Create Next App</title>
                <meta
                    name="description"
                    content="Generated by create next app"
                />
                <link rel="icon" href="/favicon.ico" />
            </Head>

            <main className="flex flex-col w-full px-10 gap-2">
                <h1 className="font-bold underline ">Encurte seus Links</h1>

                <input
                    type="text"
                    className="w-full h-9 bg-gray-300 flex items-center px-2 rounded-md"
                    value={input}
                    onChange={(event) => {
                        setInput(event.target.value);
                    }}
                />

                <button
                    className="px-5 bg-gray-100"
                    onClick={async () => {
                        try {
                            const result = await api.post("link", {
                                link: input,
                            });
                            // if (result.data.result === null) {
                            //     throw new Error();
                            // }
                            setShortUrl(result.data.result);
                            console.log("aqui: ", shortUrl);
                        } catch (e) {
                            console.log("erro");
                        }
                    }}
                >
                    Criar
                </button>

                <div className="w-full h-9 bg-gray-300 flex items-center px-2 rounded-md">
                    {shortUrl.short
                        ? `${hostname}/api/${shortUrl.short}`
                        : "..."}
                </div>

                {status === "authenticated" ? (
                    <button
                        className="px-5 bg-gray-100"
                        onClick={async () => {
                            try {
                                await api.post("", { linkId: shortUrl.id });
                            } catch (e) {
                                router.push("/");
                                console.log(e);
                            }
                        }}
                    >
                        Save
                    </button>
                ) : (
                    <></>
                )}
            </main>
        </div>
    );
};

export default Home;
